<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>InstaTrack ¬∑ Tableau de bord</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
	<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script
		defer
		src="{{ url_for('static', filename='js/chart.js') }}"
		data-daily="{{ daily | tojson }}"
	></script>
</head>
<body>
	<div class="gradient-bg" aria-hidden="true"></div>
	<header class="header">
		<div class="header__content">
			<div>
				<h1>InstaTrack</h1>
				<p>Analyse consolid√©e des interactions Instagram</p>
			</div>
			<div class="header__meta">
				<div>
					<span class="meta-label">P√©riode analys√©e</span>
					<span class="meta-value">
						{% if selected_start or selected_end %}
							{{ selected_start or '‚Äî' }} ‚Üí {{ selected_end or '‚Äî' }}
						{% else %}
							{{ selected_days }} jours
						{% endif %}
					</span>
				</div>
				<div>
					<span class="meta-label">Derni√®re mise √† jour</span>
					<span class="meta-value">{{ totals.last_updated or '‚Äî' }}</span>
				</div>
			</div>
		</div>
	</header>

	<main class="content">
		{% if accounts %}
		<form class="filters" method="get" data-default-days="{{ selected_days }}" data-range-start="{{ selected_start }}" data-range-end="{{ selected_end }}">
			<div class="field">
				<label for="account">Compte suivi</label>
				<select id="account" name="account">
					{% for account in accounts %}
					<option value="{{ account }}" {% if account == default_account %}selected{% endif %}>{{ account }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="field">
				<label for="days">Fen√™tre</label>
				<select id="days" name="days">
					{% for value in timeframes %}
					<option value="{{ value }}" {% if value == selected_days %}selected{% endif %}>{{ value }} jours</option>
					{% endfor %}
				</select>
			</div>
			<div class="field">
				<label for="start">Date de d√©but</label>
				<input type="date" id="start" name="start" value="{{ selected_start }}">
			</div>
			<div class="field">
				<label for="end">Date de fin</label>
				<input type="date" id="end" name="end" value="{{ selected_end }}">
			</div>
			<button type="submit" class="btn btn--primary">Actualiser</button>
			<a
				class="btn btn--ghost"
				href="{{ url_for('export_csv', account=default_account, days=selected_days, start=selected_start if selected_start else None, end=selected_end if selected_end else None) }}"
			>
				Exporter CSV
			</a>
			<a
				class="btn btn--ghost"
				href="{{ url_for('dashboard', account=default_account, days=selected_days) }}"
				id="resetRangeBtn"
			>
				R√©initialiser la plage
			</a>
		</form>
		{% endif %}

		<section class="action-bar" aria-label="Actions rapides">
			<button type="button" class="btn btn--ghost" id="toggleChartsBtn">
				Masquer les graphiques
			</button>
			<button type="button" class="btn btn--primary" id="runSnapshotBtn">
				Lancer une capture
			</button>
			<button type="button" class="btn btn--ghost" id="viewReportBtn">
				Voir le rapport
			</button>
			<button type="button" class="btn btn--ghost" id="startScheduleBtn">
				Activer la planification
			</button>
		</section>

		<div id="actionStatus" class="action-status" role="status" aria-live="polite" hidden></div>

		<section class="metrics-grid">
			<div class="metric-card">
				<span class="metric-label">Followers totaux</span>
				<span class="metric-value">{{ totals.followers_total }}</span>
				<span class="metric-sub">Actualis√© le {{ totals.followers_updated_at or '‚Äî' }}</span>
			</div>
			<div class="metric-card">
				<span class="metric-label">Following totaux</span>
				<span class="metric-value">{{ totals.following_total }}</span>
				<span class="metric-sub">Actualis√© le {{ totals.following_updated_at or '‚Äî' }}</span>
			</div>
			<div class="metric-card">
				<span class="metric-label">Net followers</span>
				<span class="metric-value {{ 'value-positive' if insights.net_followers > 0 else 'value-negative' if insights.net_followers < 0 else '' }}">{{ insights.net_followers }}</span>
				<span class="metric-sub">Sur la p√©riode s√©lectionn√©e</span>
			</div>
			<div class="metric-card">
				<span class="metric-label">Net following</span>
				<span class="metric-value {{ 'value-positive' if insights.net_following > 0 else 'value-negative' if insights.net_following < 0 else '' }}">{{ insights.net_following }}</span>
				<span class="metric-sub">Comptes suivis gagn√©s/perdus</span>
			</div>
			<div class="metric-card">
				<span class="metric-label">Total des changements</span>
				<span class="metric-value">{{ insights.total_changes }}</span>
				<span class="metric-sub">Followers & following confondus</span>
			</div>
			<div class="metric-card">
				<span class="metric-label">S√©rie positive</span>
				<span class="metric-value">{{ insights.positive_streak_days }}</span>
				<span class="metric-sub">Jours cons√©cutifs en hausse</span>
			</div>
		</section>

		<section class="panel-row">
			<article class="panel">
				<div class="panel-header">
					<h2>Followers ¬∑ Historique</h2>
					<p>Ajouts, suppressions et net sur {{ selected_days }} jours</p>
				</div>
				<canvas id="followersChart"></canvas>
			</article>
			<article class="panel">
				<div class="panel-header">
					<h2>Following ¬∑ Historique</h2>
					<p>Evolution des comptes suivis</p>
				</div>
				<canvas id="followingChart"></canvas>
			</article>
		</section>

		<section class="panel-grid">
			<article class="panel insights">
				<div class="panel-header">
					<h2>Insights cl√©s</h2>
					<p>Indicateurs d√©riv√©s sur la p√©riode</p>
				</div>
				<ul class="insight-list">
					<li>
						<span class="insight-label">Croissance moyenne / jour</span>
						<span class="insight-value">{{ insights.average_daily_followers }}</span>
					</li>
					<li>
						<span class="insight-label">Variation moyenne following</span>
						<span class="insight-value">{{ insights.average_daily_following }}</span>
					</li>
					<li>
						<span class="insight-label">Derni√®re activit√©</span>
						<span class="insight-value">{{ insights.latest_activity.detected_at if insights.latest_activity else '‚Äî' }}</span>
					</li>
				</ul>
				{% if insights.best_day %}
				<div class="insight-highlight insight-highlight--positive">
					<strong>Jour record</strong>
					<p>{{ insights.best_day.date }} ¬∑ +{{ insights.best_day.followers_net }} followers</p>
				</div>
				{% endif %}
				{% if insights.worst_day %}
				<div class="insight-highlight insight-highlight--neutral">
					<strong>Jour le plus calme</strong>
					<p>{{ insights.worst_day.date }} ¬∑ {{ insights.worst_day.followers_net }} followers</p>
				</div>
				{% endif %}
		</article>
			<article class="panel list-panel">
				<div class="panel-header">
					<h2>Followers gagn√©s</h2>
					<p>Top {{ insights.top_new_followers | length or 0 }} des entr√©es r√©centes</p>
				</div>
				<ul class="change-list">
					{% for change in insights.top_new_followers %}
					<li>
						<div>
							<span class="change-user">{{ change['username'] or change['full_name'] or 'Inconnu' }}</span>
							<span class="change-meta">{{ change['detected_at'] | replace('T', ' ') }}</span>
						</div>
					</li>
					{% else %}
					<li class="empty">Aucun nouveau follower durant cette p√©riode.</li>
					{% endfor %}
				</ul>
			</article>
			<article class="panel list-panel">
				<div class="panel-header">
					<h2>Followers perdus</h2>
					<p>Suivi des d√©parts les plus r√©cents</p>
				</div>
				<ul class="change-list">
					{% for change in insights.top_lost_followers %}
					<li>
						<div>
							<span class="change-user">{{ change['username'] or change['full_name'] or 'Inconnu' }}</span>
							<span class="change-meta">{{ change['detected_at'] | replace('T', ' ') }}</span>
						</div>
					</li>
					{% else %}
					<li class="empty">Aucune perte d√©tect√©e sur la p√©riode.</li>
					{% endfor %}
				</ul>
			</article>
		</section>

		<section class="panel comparison-panel">
			<div class="panel-header">
				<h2>Comparaison des snapshots</h2>
				<p>
					{% if selected_start or selected_end %}
						Analyse du {{ selected_start or 'd√©but' }} au {{ selected_end or 'fin' }}
					{% else %}
						Analyse sur {{ selected_days }} jours
					{% endif %}
				</p>
			</div>
			{% if comparison.available %}
			<div class="comparison-columns">
				{% for list_type in ['followers', 'following'] %}
				{% set section = comparison[list_type] %}
				<div class="comparison-column">
					<h3>{{ 'Followers' if list_type == 'followers' else 'Following' }}</h3>
					<div class="comparison-meta">
						<div>
							<span class="meta-label">Snapshot initial</span>
							<span class="meta-value">{{ section.baseline.collected_at if section.baseline else '‚Äî' }}</span>
							<span class="meta-sub">{{ section.baseline.count if section.baseline else 0 }} comptes</span>
						</div>
						<div>
							<span class="meta-label">Snapshot final</span>
							<span class="meta-value">{{ section.current.collected_at if section.current else '‚Äî' }}</span>
							<span class="meta-sub">{{ section.current.count if section.current else 0 }} comptes</span>
						</div>
					</div>
					<div class="comparison-lists">
						<div>
							<h4>Ajouts ({{ section.added_total }})</h4>
							<ul class="change-list">
								{% for user in section.added %}
								<li>
									<span class="change-user">{{ user.username or user.full_name or 'Inconnu' }}</span>
									<span class="change-meta">{{ user.full_name if user.username and user.full_name else user.username or user.full_name or '‚Äî' }}</span>
								</li>
								{% else %}
								<li class="empty">Aucun ajout sur la p√©riode.</li>
								{% endfor %}
							</ul>
						</div>
						<div>
							<h4>Suppressions ({{ section.removed_total }})</h4>
							<ul class="change-list">
								{% for user in section.removed %}
								<li>
									<span class="change-user">{{ user.username or user.full_name or 'Inconnu' }}</span>
									<span class="change-meta">{{ user.full_name if user.username and user.full_name else user.username or user.full_name or '‚Äî' }}</span>
								</li>
								{% else %}
								<li class="empty">Aucune suppression sur la p√©riode.</li>
								{% endfor %}
							</ul>
						</div>
					</div>
				</div>
				{% endfor %}
			</div>
			{% else %}
			<p class="empty">Aucun snapshot disponible pour cette plage. Lancez une capture pour construire l'historique.</p>
			{% endif %}
		</section>

		<section class="panel followback-panel">
			<div class="panel-header">
				<h2>Who Doesn‚Äôt Follow Back üëÄ</h2>
				<p>Comparaison de vos listes following et followers</p>
			</div>
			<div class="followback-meta">
				<span>Followers ¬∑ {{ gaps.updated_at.followers or '‚Äî' }}</span>
				<span>Following ¬∑ {{ gaps.updated_at.following or '‚Äî' }}</span>
			</div>
			<div class="followback-columns">
				<div class="followback-column">
					<h3>Not Following You Back</h3>
					<p class="followback-count">
						{{ gaps.not_following_you_back.count }} comptes
						{% if gaps.not_following_you_back.count > (gaps.not_following_you_back.users | length) %}
							<span class="badge">Top {{ gaps.not_following_you_back.users | length }}</span>
						{% endif %}
					</p>
					<ul class="change-list">
						{% for user in gaps.not_following_you_back.users %}
						<li>
							<div>
								<span class="change-user">{{ user.username or user.full_name or 'Inconnu' }}</span>
								<span class="change-meta">{{ user.full_name if user.username and user.full_name else user.username or user.full_name or '‚Äî' }}</span>
							</div>
						</li>
						{% else %}
						<li class="empty">Tout le monde vous suit en retour üéâ</li>
						{% endfor %}
					</ul>
				</div>
				<div class="followback-column">
					<h3>You Don‚Äôt Follow Back</h3>
					<p class="followback-count">
						{{ gaps.you_dont_follow_back.count }} comptes
						{% if gaps.you_dont_follow_back.count > (gaps.you_dont_follow_back.users | length) %}
							<span class="badge">Top {{ gaps.you_dont_follow_back.users | length }}</span>
						{% endif %}
					</p>
					<ul class="change-list">
						{% for user in gaps.you_dont_follow_back.users %}
						<li>
							<div>
								<span class="change-user">{{ user.username or user.full_name or 'Inconnu' }}</span>
								<span class="change-meta">{{ user.full_name if user.username and user.full_name else user.username or user.full_name or '‚Äî' }}</span>
							</div>
						</li>
						{% else %}
						<li class="empty">Vous suivez tout le monde en retour üëç</li>
						{% endfor %}
					</ul>
				</div>
			</div>
		</section>

		<section class="panel history-panel">
			<div class="panel-header">
				<h2>Archives des snapshots</h2>
				<p>Liste des captures enregistr√©es pour la p√©riode s√©lectionn√©e</p>
			</div>
			<div class="history-columns">
				{% for list_type in ['followers', 'following'] %}
				{% set entries = history[list_type] %}
				<div class="history-column">
					<h3>{{ 'Followers' if list_type == 'followers' else 'Following' }}</h3>
					<ul class="history-list">
						{% for snapshot in entries %}
						<li>
							<span class="history-date">{{ snapshot.collected_at or '‚Äî' }}</span>
							<span class="history-count">{{ snapshot.count }} comptes</span>
						</li>
						{% else %}
						<li class="empty">Aucune archive disponible sur la p√©riode.</li>
						{% endfor %}
					</ul>
				</div>
				{% endfor %}
			</div>
		</section>

		<section class="panel full-width">
			<div class="panel-header">
				<h2>Flux des √©v√®nements</h2>
				<p>Historique d√©taill√© des modifications</p>
			</div>
			{% if change_limit %}
			<p class="table-note">Affichage des {{ change_limit }} derniers √©v√©nements (utilisez l'export CSV pour le d√©tail complet).</p>
			{% endif %}
			{% if changes %}
			<table class="data-table">
				<thead>
					<tr>
						<th>Date</th>
						<th>Liste</th>
						<th>Action</th>
						<th>Utilisateur</th>
						<th>Nom complet</th>
					</tr>
				</thead>
				<tbody>
					{% for change in changes %}
					<tr>
						<td>{{ change['detected_at'] | replace('T', ' ') }}</td>
						<td>{{ change['list_type'] }}</td>
						<td class="{% if change['change_type'] == 'added' %}value-positive{% else %}value-negative{% endif %}">
							{{ 'Ajout' if change['change_type'] == 'added' else 'Suppression' }}
						</td>
						<td>{{ change['username'] or '‚Äî' }}</td>
						<td>{{ change['full_name'] or '‚Äî' }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
			{% else %}
			<p class="empty">Aucun changement enregistr√© pour cette p√©riode.</p>
			{% endif %}
		</section>
	</main>

	<div id="reportModal" class="modal" hidden tabindex="-1">
		<div class="modal__backdrop" data-close="modal"></div>
		<div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle">
			<button type="button" class="modal__close" data-close="modal" aria-label="Fermer le rapport">√ó</button>
			<h3 id="reportModalTitle">Rapport d√©taill√©</h3>
			<div id="reportModalBody" class="modal__body"></div>
		</div>
	</div>
</body>
</html>
